# ๐ ุฃูุซูุฉ ุนูููุฉ ุนูู ุขููุฉ UPSERT

## ูุง ูู UPSERTุ

**UPSERT = UPDATE + INSERT**

- ุฅุฐุง ูุงู ุงูุณุฌู ููุฌูุฏ (ููุณ ุงูู ID) โ **ูุชู ุงูุชุญุฏูุซ (UPDATE)**
- ุฅุฐุง ูุงู ุงูุณุฌู ุบูุฑ ููุฌูุฏ โ **ูุชู ุงูุฅุฏุฑุงุฌ (INSERT)**

---

## ๐ ูุซุงู 1: ุชุญุฏูุซ ูุณุชุฎุฏู ููุฌูุฏ

### **ุงููุถุน ุงูุญุงูู ูู Supabase:**

```sql
-- ุฌุฏูู users
id                                   | username  | name              | email
-------------------------------------|-----------|-------------------|------------------
11111111-1111-1111-1111-111111111111 | director  | Old Director Name | old@email.com
```

### **ููู JSON ุงููุณุชูุฑุฏ:**

```json
{
  "data": {
    "users": [
      {
        "id": "11111111-1111-1111-1111-111111111111",
        "username": "director",
        "name": "New Director Name",
        "email": "new@email.com"
      }
    ]
  }
}
```

### **ุงูููุฏ ุงููููุฐ:**

```typescript
await supabase
  .from('users')
  .upsert([
    {
      id: "11111111-1111-1111-1111-111111111111",
      username: "director",
      name: "New Director Name",
      email: "new@email.com"
    }
  ], { onConflict: 'id' });
```

### **ุงููุชูุฌุฉ ุจุนุฏ ุงูุงุณุชูุฑุงุฏ:**

```sql
-- ุฌุฏูู users
id                                   | username  | name              | email
-------------------------------------|-----------|-------------------|------------------
11111111-1111-1111-1111-111111111111 | director  | New Director Name | new@email.com
                                                   โ ุชู ุงูุชุญุฏูุซ        โ ุชู ุงูุชุญุฏูุซ
```

โ **ุชู ุงูุชุญุฏูุซ (UPDATE)** ูุฃู ุงูู ID ููุฌูุฏ

---

## ๐ ูุซุงู 2: ุฅุฏุฑุงุฌ ูุณุชุฎุฏู ุฌุฏูุฏ

### **ุงููุถุน ุงูุญุงูู ูู Supabase:**

```sql
-- ุฌุฏูู users
id                                   | username  | name              | email
-------------------------------------|-----------|-------------------|------------------
11111111-1111-1111-1111-111111111111 | director  | Director Name     | director@email.com
```

### **ููู JSON ุงููุณุชูุฑุฏ:**

```json
{
  "data": {
    "users": [
      {
        "id": "99999999-9999-9999-9999-999999999999",
        "username": "newuser",
        "name": "New User",
        "email": "newuser@email.com"
      }
    ]
  }
}
```

### **ุงูููุฏ ุงููููุฐ:**

```typescript
await supabase
  .from('users')
  .upsert([
    {
      id: "99999999-9999-9999-9999-999999999999",
      username: "newuser",
      name: "New User",
      email: "newuser@email.com"
    }
  ], { onConflict: 'id' });
```

### **ุงููุชูุฌุฉ ุจุนุฏ ุงูุงุณุชูุฑุงุฏ:**

```sql
-- ุฌุฏูู users
id                                   | username  | name              | email
-------------------------------------|-----------|-------------------|------------------
11111111-1111-1111-1111-111111111111 | director  | Director Name     | director@email.com
99999999-9999-9999-9999-999999999999 | newuser   | New User          | newuser@email.com
                                                   โ ุณุฌู ุฌุฏูุฏ ุชู ุฅุฏุฑุงุฌู
```

โ **ุชู ุงูุฅุฏุฑุงุฌ (INSERT)** ูุฃู ุงูู ID ุบูุฑ ููุฌูุฏ

---

## ๐ ูุซุงู 3: ุงุณุชูุฑุงุฏ ุนุฏุฉ ุณุฌูุงุช (ุจุนุถูุง ููุฌูุฏ ูุจุนุถูุง ุฌุฏูุฏ)

### **ุงููุถุน ุงูุญุงูู ูู Supabase:**

```sql
-- ุฌุฏูู suppliers
id                                   | name_ar                  | phone
-------------------------------------|--------------------------|-------------
00011111-1111-1111-1111-111111111111 | ุดุฑูุฉ ุฃููุง ููุชูุฑูุฏุงุช      | 0501234567
00022222-2222-2222-2222-222222222222 | ูุคุณุณุฉ ุจูุชุง ุงูุชุฌุงุฑูุฉ     | 0557654321
```

### **ููู JSON ุงููุณุชูุฑุฏ:**

```json
{
  "data": {
    "suppliers": [
      {
        "id": "00011111-1111-1111-1111-111111111111",
        "name_ar": "ุดุฑูุฉ ุฃููุง ุงููุญุฏุซุฉ",
        "phone": "0509999999"
      },
      {
        "id": "00033333-3333-3333-3333-333333333333",
        "name_ar": "ุดุฑูุฉ ุฌุงูุง ุงูุฌุฏูุฏุฉ",
        "phone": "0551111111"
      }
    ]
  }
}
```

### **ุงูููุฏ ุงููููุฐ:**

```typescript
await supabase
  .from('suppliers')
  .upsert([
    {
      id: "00011111-1111-1111-1111-111111111111",
      name_ar: "ุดุฑูุฉ ุฃููุง ุงููุญุฏุซุฉ",
      phone: "0509999999"
    },
    {
      id: "00033333-3333-3333-3333-333333333333",
      name_ar: "ุดุฑูุฉ ุฌุงูุง ุงูุฌุฏูุฏุฉ",
      phone: "0551111111"
    }
  ], { onConflict: 'id' });
```

### **ุงููุชูุฌุฉ ุจุนุฏ ุงูุงุณุชูุฑุงุฏ:**

```sql
-- ุฌุฏูู suppliers
id                                   | name_ar                  | phone
-------------------------------------|--------------------------|-------------
00011111-1111-1111-1111-111111111111 | ุดุฑูุฉ ุฃููุง ุงููุญุฏุซุฉ        | 0509999999
                                       โ ุชู ุงูุชุญุฏูุซ              โ ุชู ุงูุชุญุฏูุซ
00022222-2222-2222-2222-222222222222 | ูุคุณุณุฉ ุจูุชุง ุงูุชุฌุงุฑูุฉ     | 0557654321
                                       โ ูู ูุชุบูุฑ (ูู ููู ูู ุงูููู)
00033333-3333-3333-3333-333333333333 | ุดุฑูุฉ ุฌุงูุง ุงูุฌุฏูุฏุฉ        | 0551111111
                                       โ ุณุฌู ุฌุฏูุฏ ุชู ุฅุฏุฑุงุฌู
```

โ **ุงูุณุฌู ุงูุฃูู:** ุชู ุงูุชุญุฏูุซ (UPDATE)  
โ **ุงูุณุฌู ุงูุซุงูู:** ูู ูุชุบูุฑ (ูู ููู ูู ููู ุงูุงุณุชูุฑุงุฏ)  
โ **ุงูุณุฌู ุงูุซุงูุซ:** ุชู ุงูุฅุฏุฑุงุฌ (INSERT)

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. **ูุง ูุชู ุญุฐู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ**

```typescript
// ุงููุถุน ุงูุญุงูู: 100 ูุณุชุฎุฏู ูู Supabase
// ููู ุงูุงุณุชูุฑุงุฏ: 5 ูุณุชุฎุฏููู ููุท

await importDatabaseBackup(file);

// ุงููุชูุฌุฉ: 100 ูุณุชุฎุฏู (95 ูู ูุชุบูุฑูุง + 5 ุชู ุชุญุฏูุซูู/ุฅุฏุฑุงุฌูู)
// โ ูุง ูุชู ุญุฐู ุงูู 95 ูุณุชุฎุฏู ุงูุขุฎุฑูู
```

### 2. **ุงูููุชุงุญ ุงูุฃุณุงุณู (Primary Key) ูู ID**

```typescript
.upsert(data, { onConflict: 'id' })
                           โ
                    ูุชู ุงูููุงุฑูุฉ ุจูุงุกู ุนูู ID
```

### 3. **ุฌููุน ุงูุญููู ูุชู ุชุญุฏูุซูุง**

```typescript
// ุงูุณุฌู ุงูููุฌูุฏ:
{ id: "111", name: "Old", email: "old@email.com", phone: "123" }

// ุงูุณุฌู ุงูุฌุฏูุฏ:
{ id: "111", name: "New", email: "new@email.com" }

// ุงููุชูุฌุฉ:
{ id: "111", name: "New", email: "new@email.com", phone: null }
                                                            โ
                                                    ุชู ุญุฐูู ูุฃูู ุบูุฑ ููุฌูุฏ ูู ุงูููู
```

โ๏ธ **ุชุญุฐูุฑ:** ุฅุฐุง ูุงู ุงูููู ูุง ูุญุชูู ุนูู ุญูู ูุนููุ ุณูุชู ุชุนูููู ุฅูู `null`

---

## ๐ฏ ุญุงูุงุช ุงูุงุณุชุฎุฏุงู ุงูุนูููุฉ

### **ุญุงูุฉ 1: ููู ุงูุจูุงูุงุช ูู ุจูุฆุฉ Development ุฅูู Production**

```bash
# ูู ุจูุฆุฉ Development
1. ุชุตุฏูุฑ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
2. ุชุญููู ููู orgaflow-backup-2025-01-25.json

# ูู ุจูุฆุฉ Production
3. ุงุณุชูุฑุงุฏ ุงูููู
4. โ ุฌููุน ุงูุจูุงูุงุช ุชู ููููุง
```

### **ุญุงูุฉ 2: ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจุนุฏ ุฎุทุฃ**

```bash
# ูุจู ุฅุฌุฑุงุก ุชุบููุฑุงุช ุฎุทูุฑุฉ
1. ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ

# ุจุนุฏ ุญุฏูุซ ุฎุทุฃ
2. ุงุณุชูุฑุงุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
3. โ ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
```

### **ุญุงูุฉ 3: ุฏูุฌ ุจูุงูุงุช ูู ูุตุฏุฑูู**

```bash
# ูุฏูู ุจูุงูุงุช ูู ุจูุฆุชูู ูุฎุชููุชูู
1. ุชุตุฏูุฑ ูู ุงูุจูุฆุฉ A
2. ุชุตุฏูุฑ ูู ุงูุจูุฆุฉ B
3. ุฏูุฌ ุงูููููู ูุฏููุงู (JSON)
4. ุงุณุชูุฑุงุฏ ุงูููู ุงููุฏูุฌ
5. โ ุฌููุน ุงูุจูุงูุงุช ูู ููุงู ูุงุญุฏ
```

---

## ๐ ุฎูุงุตุฉ

| ุงูุนูููุฉ | ุงูุดุฑุญ | ูุซุงู |
|---------|--------|------|
| **UPSERT** | ุชุญุฏูุซ ุฃู ุฅุฏุฑุงุฌ | `supabase.from('users').upsert(data)` |
| **UPDATE** | ุชุญุฏูุซ ุณุฌู ููุฌูุฏ | ID ููุฌูุฏ โ ุชุญุฏูุซ |
| **INSERT** | ุฅุฏุฑุงุฌ ุณุฌู ุฌุฏูุฏ | ID ุบูุฑ ููุฌูุฏ โ ุฅุฏุฑุงุฌ |
| **onConflict** | ุงูููุชุงุญ ููููุงุฑูุฉ | `{ onConflict: 'id' }` |

---

**ุงูุขู ูููุช ููู ูุนูู UPSERTุ** ๐ฏ

